---
// Layouts
import Layout from "../layouts/Layout.astro";

// Components
import HeaderContent from "../components/HeaderContent.astro";
import MainContent from "../components/MainContent.astro";
---

<Layout>
  <div class="container">
    <div class="row">

      <HeaderContent />
      <MainContent />      
      
    </div>
  </div>
</Layout>

<script is:inline>
  // ConfiguraciÃ³n inicial
  let currentConfig = {
    title: "ðŸŒŸ INFORME DE HABILIDAD",
    characterLabel: "Personaje",
    defaultAnalysis: "Resultado estÃ¡ndar de la acciÃ³n",
    defaultRecommendation: "Sigue practicando para mejorar",
  };

  let currentSkills = [
    {
      name: "Piloto âœˆï¸",
      messages: [
        "Â¡Impacto inminente!",
        "Error de navegaciÃ³n",
        "Aterrizaje forzoso",
        "Vuelo estable",
        "Â¡Acrobacias espaciales perfectas!",
      ],
      analysis: [
        "Desastre total en el vuelo",
        "Necesita mÃ¡s horas de prÃ¡ctica",
        "Aterrizaje aceptable",
        "Vuelo controlado",
        "Maniobras perfectas",
      ],
      recommendations: [
        "Revisar manual de vuelo",
        "Practicar en simulador",
        "Tomar lecciones adicionales",
        "Mantener el buen trabajo",
        "Â¡Eres un as del aire!",
      ],
    },
    {
      name: "Combate ðŸ”«",
      messages: [
        "Â¡Arma encasquillada!",
        "Disparo errado",
        "DaÃ±o parcial",
        "Blanco neutralizado",
        "Â¡Disparo crÃ­tico!",
      ],
      analysis: [
        "Fallo catastrÃ³fico",
        "Necesita entrenamiento",
        "Resultado aceptable",
        "Buen desempeÃ±o",
        "Excelente punterÃ­a",
      ],
      recommendations: [
        "Revisar el arma",
        "Practicar punterÃ­a",
        "Mejorar tÃ©cnica",
        "Mantener precisiÃ³n",
        "Â¡Eres un francotirador!",
      ],
    },
  ];

  // VerificaciÃ³n inicial al cargar la pÃ¡gina
  document.addEventListener("DOMContentLoaded", function () {
    const webhookURL = localStorage.getItem("discordWebhookURL");
    const backButton = document.getElementById("backwhurl");
    const webhookForm = document.getElementById("webhook-form");
    const dadosSection = document.getElementById("dados-section");

    if (webhookURL) {
      webhookForm.style.display = "none";
      dadosSection.style.display = "block";
      backButton.style.display = "block";

      // Actualizar dropdown con habilidades actuales
      actualizarDropdownHabilidades();
    } else {
      webhookForm.style.display = "block";
      dadosSection.style.display = "none";
      backButton.style.display = "none";
    }
  });

  function resetWebhookConfig() {
    // Limpiar el webhook almacenado
    localStorage.removeItem("discordWebhookURL");

    // Restablecer el campo de URL
    document.getElementById("webhook-url").value = "";

    // Mostrar el formulario de configuraciÃ³n
    document.getElementById("webhook-form").style.display = "block";

    // Ocultar la secciÃ³n de habilidades
    document.getElementById("dados-section").style.display = "none";

    // Ocultar el botÃ³n "Nuevo Webhook"
    document.getElementById("backwhurl").style.display = "none";

    // Limpiar resultados anteriores
    document.getElementById("result").style.display = "none";
  }

  function actualizarDropdownHabilidades() {
    const skillSelect = document.getElementById("skill-name");
    skillSelect.innerHTML = ""; // Limpiar opciones existentes

    currentSkills.forEach((skill) => {
      const option = document.createElement("option");
      option.value = skill.name;
      option.textContent = skill.name;
      skillSelect.appendChild(option);
    });
  }

  function guardarWebhook() {
    const url = document.getElementById("webhook-url").value.trim();

    if (!url.startsWith("https://discord.com/api/webhooks/")) {
      alert("ERROR: ENLACE DE WEBHOOK NO VÃLIDO");
      return;
    }

    localStorage.setItem("discordWebhookURL", url);
    document.getElementById("webhook-form").style.display = "none";
    document.getElementById("dados-section").style.display = "block";
    document.getElementById("backwhurl").style.display = "block";

    // Limpiar campo de nombre de personaje para nueva simulaciÃ³n
    document.getElementById("character-name").value = "";
  }

  document.getElementById("loadJson").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const config = JSON.parse(e.target.result);

        // Actualizar configuraciÃ³n general
        if (config.config) {
          currentConfig = {
            ...currentConfig,
            ...config.config,
          };
        }

        // Actualizar habilidades
        if (config.skills && Array.isArray(config.skills)) {
          currentSkills = config.skills;
          actualizarDropdownHabilidades();
        }

        alert("ConfiguraciÃ³n personalizada cargada correctamente");
      } catch (error) {
        alert("Error: El archivo JSON no es vÃ¡lido\n" + error.message);
        console.error(error);
      }
    };
    reader.readAsText(file);
  });

  function copiarJsonBase() {
    const jsonBase = JSON.stringify(
      {
        config: currentConfig,
        skills: currentSkills,
      },
      null,
      2
    );

    navigator.clipboard
      .writeText(jsonBase)
      .then(() => alert("JSON base copiado al portapeles"))
      .catch((err) => console.error("Error al copiar:", err));
  }

  function determinarResultado(puntos, tirada) {
    const porcentajeExito = puntos * 20;
    const umbrales = [
      {
        max: 20,
        texto: "FALLO CRÃTICO ðŸ’¥ Â¡SISTEMA COLAPSADO!",
        descripcion:
          "La acciÃ³n ha fallado catastrÃ³ficamente con consecuencias graves.",
        clase: "critical",
      },
      {
        max: 40,
        texto: "FALLO TÃ‰CNICO ðŸ› ï¸",
        descripcion: "El intento no tuvo Ã©xito pero sin daÃ±os colaterales.",
        clase: "failure",
      },
      {
        max: 60,
        texto: "Ã‰XITO PARCIAL âš¡",
        descripcion: "Logro conseguido pero con complicaciones.",
        clase: "partial",
      },
      {
        max: 80,
        texto: "Ã‰XITO TOTAL âœ…",
        descripcion: "La operaciÃ³n se completÃ³ segÃºn lo planeado.",
        clase: "success",
      },
      {
        max: 100,
        texto: "Ã‰XITO SOBRESALIENTE ðŸš€",
        descripcion: "Resultado excepcional con beneficios adicionales.",
        clase: "epic",
      },
    ];

    const porcentajeReal = puntos >= 5 ? 100 : porcentajeExito;
    const porcentajeObtenido = (tirada / 20) * 100;
    const porcentajeEfectivo = (porcentajeObtenido * porcentajeReal) / 100;

    for (let umbral of umbrales) {
      if (porcentajeEfectivo <= umbral.max) {
        return {
          texto: umbral.texto,
          descripcion: umbral.descripcion,
          clase: umbral.clase,
          porcentaje: Math.round(porcentajeEfectivo),
        };
      }
    }

    return {
      texto: "Ã‰XITO SOBRESALIENTE ðŸš€",
      descripcion: "Resultado excepcional con beneficios adicionales.",
      clase: "epic",
      porcentaje: 100,
    };
  }

  async function tirarDados() {
    const webhookURL = localStorage.getItem("discordWebhookURL");
    if (!webhookURL) {
      alert("ERROR: SISTEMA NO CONFIGURADO");
      return;
    }

    const characterName = document
      .getElementById("character-name")
      .value.trim();
    if (!characterName) {
      alert("ERROR: NOMBRE NO ESPECIFICADO");
      return;
    }

    const skillPoints = parseInt(document.getElementById("skill-points").value);
    if (skillPoints < 1 || skillPoints > 6) {
      alert("ERROR: NIVEL DE HABILIDAD INVÃLIDO");
      return;
    }

    const skillName = document.getElementById("skill-name").value;
    const tirada = Math.floor(Math.random() * 20) + 1;
    const resultado = determinarResultado(skillPoints, tirada);
    const skill = currentSkills.find((s) => s.name === skillName) || {};

    // Obtener mensajes personalizados
    const resultIndex = Math.min(Math.floor(resultado.porcentaje / 20), 4);
    const skillMessage =
      skill.messages?.[resultIndex] || "Resultado no definido";
    const analysis =
      skill.analysis?.[resultIndex] || currentConfig.defaultAnalysis;
    const recommendation =
      skill.recommendations?.[resultIndex] ||
      currentConfig.defaultRecommendation;

    // Mostrar resultado local
    const resultDiv = document.getElementById("result");
    resultDiv.style.display = "block";
    resultDiv.className = resultado.clase;
    resultDiv.innerHTML = `
      <h3>ðŸ“Š RESULTADO DE SIMULACIÃ“N</h3>
      <p><strong>${characterName}</strong> en <strong>${skillName}</strong> (Nivel ${skillPoints})</p>
      <p>ðŸŽ² Tirada: ${tirada}/20</p>
      <p>ðŸ“ˆ Eficiencia: ${resultado.porcentaje}%</p>
      <p>ðŸ’¬ <strong>${skillMessage}</strong></p>
      <p>${analysis}</p>
      <p class="${resultado.clase}">${resultado.texto}</p>
      <p>â–º RECOMENDACIÃ“N: ${recommendation}</p>
    `;

    // Crear mensaje para Discord (formato mejorado)
    const discordMessage = [
      `**${currentConfig.title}**`,
      `**${currentConfig.characterLabel}:** ${characterName}`,
      `**Habilidad:** ${skillName} (Nivel ${skillPoints})`,
      `**Tirada:** ${tirada}/20 â†’ **${resultado.texto}**`,
      `**Eficiencia:** ${resultado.porcentaje}%`,
      `**Resultado:** ${skillMessage}`,
      `**AnÃ¡lisis:** ${analysis}`,
      `**â–º RECOMENDACIÃ“N:** ${recommendation}`,
    ].join("\n");

    // Enviar a Discord
    try {
      const response = await fetch(webhookURL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          content: discordMessage,
          allowed_mentions: { parse: [] },
        }),
      });

      if (!response.ok) {
        throw new Error(`Error HTTP: ${response.status}`);
      }

      console.log("Mensaje enviado con Ã©xito a Discord");
    } catch (error) {
      console.error("Error al enviar a Discord:", error);
      alert(
        "Error al enviar a Discord. Verifica la consola para mÃ¡s detalles."
      );
    }
  }
</script>